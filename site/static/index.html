<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>rustc performance data</title>
    <link rel="stylesheet" type="text/css" href="perf.css">
</head>
<body class="container">
    <div>&gt; <a href="index.html">graphs</a>, <a href="compare.html">compare</a>.</div>
    <div id="settings">
        start: <input placeholder="yyyy-mm-dd or commit" id="start-bound" />
        end: <input placeholder="yyyy-mm-dd or commit" id="end-bound" />
        Absolute data: <input id='absolute' name="absolute" type="checkbox">
        <select id='stats' name="stat"></select>
        <a href="#" onClick="submit_settings(); return false;">Submit</a>
    </div>
    <div id="charts"></div>
    <div id="as-of"></div>
</body>
    <script src="libs/highcharts.js"></script>
    <script src="libs/fetch.js"></script>
    <script src="shared.js"></script>

    <script>
    function init_graph(response, stat, absolute) {
        let sorted_names = Object.keys(response);
        sorted_names.sort();
        document.getElementById("charts").style.display = "none";
        let title = "";
        let yAxis = "Value";
        if (stat == "instructions:u") {
            title = "Number of CPU instructions";
            yAxis = "Instructions";
        } else if (stat == "cycles:u") {
            title = "Number of CPU cycles";
            yAxis = "Cycles";
        } else if (stat == "cpu-clock") {
            title = "Wall time execution";
            yAxis = "Seconds";
        } else if (stat == "wall-time") {
            title = "Wall time execution";
            yAxis = "Seconds";
        } else if (stat == "max-rss") {
            title = "Maximum resident set size";
            yAxis = "Kilobytes";
        } else if (stat == "faults") {
            title = "Faults";
        }

        function clickHandler(event) {
            if (this.options.url) {
                window.open(this.options.url, "_blank");
            }
            return false;
        }

        function formatter() {
            let date = new Date();
            date.setUTCMilliseconds(this.x);
            let commit = this.point.commit.substr(0, 10);
            return "<b>" + date.toLocaleString() + " - " + commit + "</b>" +
                "<br>" + this.series.name + ": " + this.point.absolute.toFixed(2) + " " +
                yAxis.toLowerCase() + " (" +
                this.point.percent.toFixed(2) + "% from start)";
        }

        let elements = [];
        for (let crate_name of sorted_names) {
            let element = document.createElement("div");
            element.id = "chart-container-" + crate_name;
            document.getElementById("charts").appendChild(element);
        }
        let graphs = [];
        for (let crate_name of sorted_names) {
            graphs.push(() => {
            let benchmark_names = Object.keys(response[crate_name]);
            benchmark_names.sort();
            let datasets = [];
            for (let name of benchmark_names) {
                let data = response[crate_name][name];
                datasets.push({
                    name: data[0].benchmark,
                    animation: false,
                    allowPointSelect: true,
                    data: data,
                    marker: {
                        enabled: true
                    },
                });
            }

            let id = "chart-container-" + crate_name;
            let element = document.getElementById(id);
            let chart = new Highcharts.chart(element, {
                chart: {
                    zoomType: "xy",
                    renderTo: element,
                    type: "line",
                },
                title: {
                    text: crate_name + " - " + title,
                },
                rangeSelector: {
                    selected: 1,
                },
                series: datasets,
                tooltip: {
                    crosshairs: [true],
                    formatter: formatter,
                },
                xAxis: {
                    type: "datetime",
                },
                yAxis: absolute ? {
                    title: {
                        text: yAxis,
                    }
                } : {
                    softMax: 5,
                    softMin: -5,
                    minRange: 0.1,
                    title: {
                        text: "% change",
                    }
                },
                plotOptions: {
                    line: {
                        point: {
                            events: {
                                click: clickHandler,
                            }
                        }
                    }
                }
            });
            });
        }
        processGraphs(graphs);
        document.getElementById("charts").style.display = "block";
    }

    function processGraphs(graphs) {
        requestAnimationFrame(() => {
            graphs.shift()();
            if (graphs.length > 0) {
                processGraphs(graphs);
            }
        });
    }

    function make_graph(state) {
        let values = Object.assign({}, {
            start: "",
            end: "",
            stat: "instructions:u",
            absolute: false,
        }, state);
        make_request("/graph", values).then(function(response) {
            init_graph(response, values.stat, values.absolute);
        });
    }

    function submit_settings() {
        let start = document.getElementById("start-bound").value;
        let end = document.getElementById("end-bound").value;
        let absolute = document.getElementById("absolute").checked;
        let stat = getSelected("stats");
        let params = new URLSearchParams();
        params.append("start", start);
        params.append("end", end);
        params.append("absolute", absolute);
        params.append("stat", stat);
        window.location.search = params.toString();
    }

    load_state(make_graph);
    </script>
</html>
