<html>
<head>
    <meta charset="utf-8">
    <title>rustc performance data</title>
    <link rel="stylesheet" type="text/css" href="perf.css">
</head>
<body class="container">
    <div>&gt; <a href="index.html">graphs</a>, <a href="compare.html">compare</a>.</div>
    <div id="settings">
        start: <input placeholder="yyyy-mm-dd or commit" id="start-bound"></input>
        end: <input placeholder="yyyy-mm-dd or commit" id="end-bound"></input>
        Absolute data: <input id='absolute' name="absolute" type="checkbox">
        <select id='stats' name="stat"></select>
        <a href="#" onClick="make_graph({}, true); return false;">Submit</a>
    </div>
    <div id="charts"></div>
    <div id="as-of"></div>
</body>
    <script src="libs/highcharts.js"></script>
    <script src="libs/fetch.js"></script>
    <script src="shared.js"></script>
    <script>

    function init_graph(response) {
        let stat = "wall-time";
        let absolute = true;

        let sorted_names = Object.keys(response);
        sorted_names.sort();
        document.getElementById("charts").style.display = "none";
        let title = "";
        let yAxis = "Value";
        if (stat == "instructions:u") {
            title = "Number of CPU instructions";
            yAxis = "Instructions";
        } else if (stat == "cycles:u") {
            title = "Number of CPU cycles";
            yAxis = "Cycles";
        } else if (stat == "cpu-clock") {
            title = "Wall time execution";
            yAxis = "Seconds";
        } else if (stat == "wall-time") {
            title = "Wall time execution";
            yAxis = "Seconds";
        } else if (stat == "max-rss") {
            title = "Maximum resident set size";
            yAxis = "Kilobytes";
        }

        function clickHandler(event) {
            if (this.options.url) {
                window.open(this.options.url, "_blank");
            }
            return false;
        }

        function formatter() {
            let date = new Date(this.x);
            let commit = this.point.commit.substr(0, 10);
            return "<b>" + date.toLocaleString() + " - " + commit + "</b>" +
                "<br>" + this.series.name + ": " + this.point.absolute.toFixed(2) + " " +
                yAxis.toLowerCase() + " (" +
                this.point.percent.toFixed(2) + "% from start)";
        }

        let elements = [];
        for (let crate_name of sorted_names) {
            let element = document.createElement("div");
            element.id = "chart-container-" + crate_name;
            document.getElementById("charts").appendChild(element);
        }
        let graphs = [];
        for (let crate_name of sorted_names) {
            graphs.push(() => {
            let benchmark_names = Object.keys(response[crate_name]);
            benchmark_names.sort();
            let datasets = [];
            for (let name of benchmark_names) {
                let data = response[crate_name][name];
                datasets.push({
                    name: data[0].benchmark,
                    animation: false,
                    allowPointSelect: true,
                    data: data,
                    marker: {
                        enabled: true
                    },
                });
            }

            let id = "chart-container-" + crate_name;
            let element = document.getElementById(id);
            let chart = new Highcharts.chart(element, {
                chart: {
                    zoomType: "xy",
                    renderTo: element,
                    type: "line",
                },
                title: {
                    text: crate_name + " - " + title,
                },
                rangeSelector: {
                    selected: 1,
                },
                series: datasets,
                tooltip: {
                    crosshairs: [true],
                    formatter: formatter,
                },
                xAxis: {
                    type: "datetime",
                },
                yAxis: absolute ? {
                    title: {
                        text: yAxis,
                    }
                } : {
                    softMax: 5,
                    softMin: -5,
                    minRange: 0.1,
                    title: {
                        text: "% change",
                    }
                },
                plotOptions: {
                    line: {
                        point: {
                            events: {
                                click: clickHandler,
                            }
                        }
                    }
                }
            });
            });
        }
        processGraphs(graphs);
        document.getElementById("charts").style.display = "block";
    }

    function processGraphs(graphs) {
        requestAnimationFrame(() => {
            graphs.shift()();
            if (graphs.length > 0) {
                processGraphs(graphs);
            }
        });
    }

    function getSelectedCrates() {
        var selected = [];
        if (chart) {
            for (var i = 0; i < chart.series.length; i++) {
                var series = chart.series[i];
                if (series.visible) {
                    selected.push(series.name);
                }
            }
        }
        return selected;
    }

    function make_graph(state, push_state) {
        let values = {
            start: "f93a4928c2168bcc475b4fe77ba9f9e5494ffe1c",
            end: "d0f8e2913a93573c78cddfd297944cff4eb4c41a",
            stat: "wall-time",
            absolute: true,
        };
        make_request("/graph", values).then(function(response) {
            response.json().then(function(data) {
                init_graph(data, values.stat);
                if (push_state) {
                    push_state_to_history(values);
                }
            });
        }, function(err) {
            console.log("Error fetching data:");
            console.log(err);
        });
    }

    function hide_all() {
        if (!chart) {
            return
        }
        for (var i = 0; i < chart.series.length; i++) {
            chart.series[i].setVisible(false, false);
        }
        chart.redraw();
    }

    function show_all() {
        if (!chart) {
            return
        }
        for (var i = 0; i < chart.series.length; i++) {
            chart.series[i].setVisible(true, false);
        }
        chart.redraw();
    }

    make_settings(make_graph);
    </script>
</html>

