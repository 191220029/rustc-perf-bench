<html>
<head>
<meta charset="utf-8">
<title>rustc performance data</title>
<link rel="stylesheet" type="text/css" href="perf.css">
</head>
<body>
    <div>See also <a href="index.html">graphs</a>, <a href="stats.html">stats</a>, <a href="compare.html">comparisons</a>, <a href="mem.html">memory graph</a>.</div>
    <div>
        <br><input type="radio" name="kind" checked="true" value="benchmarks">benchmarks<br>
        <input type="radio" name="kind" value="rustc">bootstrap        
    </div>
    <div id="settings">
        <span id="dates" class="settings">
            <h3>Dates</h3>
            date: <input placeholder="yyyy-mm-dd" id="date"></input><br>
            <div class="submit">
            <a href="#" onClick="remake_table(); return false;">Submit</a>
            </div>
        </span>
    </div>
    <div id="table"></div>
</body>
    <script src="shared.js"></script>
    <script src="libs/fetch.js"></script>
    <script>
    // Read the various settings, then call make_table.
    function remake_table() {
        var kind = get_kind();
        var date = getDate("date");

        make_table(kind, date, true);
    }

    function make_table(kind, date, push_state) {
        var body = {
            date: date,
            kind: kind
        };
        var init = {
            method: "POST",
            body: JSON.stringify(body),
            mode: "cors"
        };
        fetch("http://www.ncameron.org/perf/get_tabular", init).then(function(response) {
            response.json().then(function(data) {
                populate_table(data);

                if (push_state) {
                    history.pushState({kind: kind, date: data.date}, "", "?kind=" + kind + "&date=" + encodeURIComponent(data.date));
                }
            });
        }, function(err) {
            console.log("Error fetching data:");
            console.log(err);
        });
    }

    function populate_table(data) {
        var html = "<p>date: " + data.date + "</p>";
        html += "<p>commit: " + data.commit + "</p>";

        if (data.data) {
            var rows = Object.keys(data.data).sort(sort_with_total);
            var cols = Object.keys(data.data[rows[0]]).sort(sort_with_total);

            html += "<table>";
            html += "<tr><th></th>";
            for (var c in cols) {
                var label = cols[c];
                if (label == "total") {
                    label = "total / max"
                }
                html += "<th>" + label + "</th>";
            }
            html += "</tr>";
            for (var r in rows) {
                var label = rows[r];
                if (label == "total") {
                    label = "total / max"
                }
                html += "<tr><th>" + label + "</th>"
                for (var c in cols) {
                    var datum = data.data[rows[r]][cols[c]];
                    var mem = datum.rss;
                    var rss = "";
                    if (mem) {
                        rss = mem + "mb";
                    }
                    html += "<td>" + datum.time.toFixed(2) + "s; " + rss + "</td>";
                }
                html += "</tr>"
            }
            html += "</table>";
        }

        document.getElementById("table").innerHTML = html;
    }

    function sort_with_total(a, b) {
        if (a == "total") {
            return 1;
        }
        if (b == "total") {
            return -1;
        }
        if (a == b) { return 0; }
        if (a < b) { return -1; }
        return 1;
    }

    // Respond to back/forwards properly.
    window.onpopstate = function(ev) {
        var state = ev.state;
        if (state) {
            make_table(state.kind, state.date, false);
        } else {
            document.getElementById("table").innerHTML = "";
        }
    };

    // Load the page from a URL.
    if (window.location.search) {
        var params = new URLSearchParams(window.location.search.substring(1));
        if (params.has("kind") && params.has("date")) {
            make_table(params.get("kind"), params.get("date"), false);
        }
    }
    </script>
</html>
